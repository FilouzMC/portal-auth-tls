<%+header%>

<div class="cbi-map">
  <h2>Portail Captif - Actions rapides</h2>
  <p>Ex√©cutez les scripts sans utiliser SSH.</p>

  <div class="cbi-section">
    <button class="btn cbi-button cbi-button-apply" onclick="runScript('auth', this)">üöÄ Script d'authentification</button>
    <button class="btn cbi-button cbi-button-reset" onclick="runScript('logout', this)">üî¥ Script de d√©connexion</button>
    <button class="btn cbi-button" onclick="runScript('update', this)">üîÑ V√©rifier les mises √† jour</button>
  </div>

  <div id="output" class="cbi-section hidden">
    <label>R√©sultat :</label>
    <textarea style="width:100%;height:200px" readonly></textarea>
  </div>
</div>

<script type="text/javascript">
function runScript(name, btn) {
  var outputBox = document.getElementById('output');
  var textarea = outputBox.querySelector('textarea');
  var buttons = document.querySelectorAll('button');

  buttons.forEach(function(b) { b.disabled = true; });
  var oldText = btn.innerHTML;
  btn.innerHTML = '‚è≥ Ex√©cution...';

  outputBox.classList.remove('hidden');
  textarea.value = 'Ex√©cution du script "' + name + '"...\\n';

  var xhr = new XMLHttpRequest();
  xhr.open('POST', '<%=url("admin/system/portal/run")%>', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      buttons.forEach(function(b) { b.disabled = false; });
      btn.innerHTML = oldText;

      if (xhr.status === 200) {
        try {
          var json = JSON.parse(xhr.responseText);
          if (json.success) {
            textarea.value += '\\n‚úÖ Script termin√©:\\n\\n' + json.output;
          } else {
            textarea.value += '\\n‚ùå Erreur: ' + json.output;
          }
        } catch (e) {
          textarea.value += '\\n‚ùå R√©ponse invalide: ' + e;
        }
      } else {
        textarea.value += '\\n‚ùå Erreur HTTP ' + xhr.status;
      }
    }
  };
  xhr.send('script=' + encodeURIComponent(name));
}
</script>

<%+footer%>
