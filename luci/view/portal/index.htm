<%+header%>
<div class="cbi-map">
<h2>Portal Captif</h2>

<div class="cbi-section" id="status-section">
<h3>Statut</h3>
<table class="table" style="width:100%">
<tr>
<td style="width:30%;font-weight:bold">Etat:</td>
<td id="state-val" style="color:#999">En attente...</td>
</tr>
<tr>
<td style="font-weight:bold">Statut:</td>
<td id="status-val" style="color:#999">En attente...</td>
</tr>
</table>
<button class="btn cbi-button" onclick="load_status()">Rafraichir</button>
</div>

<div class="cbi-section">
<h3 style="margin-top: 15px;">Actions</h3>
<button class="btn cbi-button" onclick="portal_run('auth')">Authentifier</button>
<button class="btn cbi-button" onclick="portal_run('logout')">Deconnecter</button>
<button class="btn cbi-button" onclick="portal_run('update')">Maj</button>
</div>

<div id="run-output-section" style="margin-top:15px;display:none">
<h3>Resultat</h3>
<textarea id="run-output-text" style="width:100%;height:180px;font-family:monospace;font-size:11px;border:1px solid #ccc;padding:5px" readonly></textarea>
</div>

<div class="cbi-section">
<h3 style="margin-top: 15px;">Configuration</h3>
<button class="btn cbi-button" onclick="load_config()">Charger</button>
<button class="btn cbi-button cbi-button-apply" onclick="save_config()" style="margin-left:5px">Sauvegarder</button>
</div>

<div id="config-section" style="margin-top:10px;display:none">
<textarea id="config-text" style="width:100%;height:200px;font-family:monospace;font-size:11px;border:1px solid #ccc;padding:5px"></textarea>
<div style="margin-top:10px;color:#999;font-size:11px">
BASE_URL, PORTAL_USER, PORTAL_PASS, etc.
</div>
</div>

<div class="cbi-section">
<h3 style="margin-top: 15px;">Patches</h3>
<button class="btn cbi-button" onclick="load_patches()">Rafraichir</button>
</div>

<div class="cbi-section">
<h3>Upload Patch</h3>
<div id="upload-area" style="border:2px dashed #999;border-radius:5px;padding:20px;text-align:center;cursor:pointer" ondrop="handle_drop(event)" ondragover="handle_dragover(event)" ondragleave="handle_dragleave(event)">
<input type="file" id="upload-input" style="display:none" accept=".sh" onchange="handle_file_select(event)">
<p style="margin:0;">Glissez-deposez un fichier .sh (contenant 'patch') ou cliquez</p>
<p style="margin:5px 0 0 0;font-size:12px;color:#999" id="upload-hint">Nom doit contenir 'patch' et finir par .sh</p>
</div>
<div id="upload-status" style="margin-top:10px;display:none">
<textarea id="upload-status-text" style="width:100%;height:100px;font-family:monospace;font-size:11px;border:1px solid #ccc;padding:5px" readonly></textarea>
</div>
</div>

<div id="patches-list-section" style="margin-top:10px;display:none">
<table id="patches-table" style="width:100%;border-collapse:collapse">
<thead>
<tr style="border-bottom:1px solid #ccc">
<th style="text-align:left;padding:5px">Patch</th>
<th style="text-align:center;width:150px">Action</th>
</tr>
</thead>
<tbody id="patches-tbody">
</tbody>
</table>
</div>

<div id="patch-run-section" style="margin-top:15px;display:none">
<h4>Resultat du patch</h4>
<textarea id="patch-run-text" style="width:100%;height:150px;font-family:monospace;font-size:11px;border:1px solid #ccc;padding:5px" readonly></textarea>
</div>

<div id="patch-view-section" style="margin-top:15px;display:none">
<h4>Code du patch</h4>
<textarea id="patch-view-text" style="width:100%;height:200px;font-family:monospace;font-size:10px;border:1px solid #ccc;padding:5px" readonly></textarea>
<div style="margin-top:10px">
<button class="btn cbi-button" onclick="patch_download_file()" style="margin-right:5px">Telecharger</button>
<button class="btn cbi-button" onclick="patch_view_logs()" style="margin-right:5px">Voir logs</button>
<button class="btn cbi-button" onclick="patch_close_view()">Fermer</button>
</div>
</div>

<div id="patch-logs-section" style="margin-top:15px;display:none">
<h4>Historique du patch</h4>
<textarea id="patch-logs-text" style="width:100%;height:250px;font-family:monospace;font-size:10px;border:1px solid #ccc;padding:5px" readonly></textarea>
<button class="btn cbi-button" onclick="patch_close_logs()" style="margin-top:10px">Fermer</button>
</div>

<div class="cbi-section" style="margin-top:30px">
<h3>Logs Systeme</h3>
<p style="margin:0 0 15px 0;color:#666;font-size:13px">Exporte tous les logs du systeme (logread)</p>
<button class="btn cbi-button" onclick="export_logs_local()" style="margin-right:10px">Exporter</button>
<button class="btn cbi-button cbi-button-apply" onclick="export_logs_paste()">Partager via Paste</button>
</div>

<div id="logs-export-section" style="margin-top:15px;display:none">
<h3>Logs exportes</h3>
<textarea id="logs-export-text" style="width:100%;height:250px;font-family:monospace;font-size:11px;border:1px solid #ccc;padding:5px" readonly></textarea>
<div style="margin-top:10px">
<button class="btn cbi-button" onclick="download_logs()" style="margin-right:5px">Telecharger</button>
<button class="btn cbi-button" onclick="copy_logs_to_clipboard()">Copier</button>
</div>
</div>

<div id="logs-paste-section" style="margin-top:15px;display:none">
<h3>Lien de partage</h3>
<p style="margin:0 0 10px 0;color:#ff6600;font-size:12px;font-weight:bold">⚠️ Ces logs sont publics et accessibles via le lien ci-dessous</p>
<p style="margin:0 0 10px 0;color:#666;font-size:12px">Cliquez sur le lien ou copiez-le:</p>
<input type="text" id="logs-paste-url" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:5px;font-family:monospace;font-size:12px;box-sizing:border-box" readonly>
<button class="btn cbi-button" onclick="copy_paste_url()" style="margin-top:10px">Copier le lien</button>
</div>

</div>

<script type="text/javascript">
function load_status() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '<%=url("admin/services/portal/status")%>', true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        var state_el = document.getElementById('state-val');
        var status_el = document.getElementById('status-val');
        if (state_el) state_el.textContent = resp.state || 'UNKNOWN';
        if (status_el) status_el.textContent = resp.status || 'N/A';
      } catch (e) {
        var el = document.getElementById('status-val');
        if (el) el.textContent = 'Erreur parse';
      }
    }
  };
  xhr.send();
}

function portal_run(name) {
  var ta = document.getElementById('run-output-text');
  var sec = document.getElementById('run-output-section');
  if (!ta || !sec) return;
  
  ta.value = 'En cours...';
  sec.style.display = 'block';
  
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '<%=url("admin/services/portal/run")%>', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        ta.value = (resp.success ? '[OK]' : '[FAIL]') + '\n' + (resp.output || '');
      } catch (e) {
        ta.value = 'Erreur: ' + e.toString();
      }
    } else {
      ta.value = 'HTTP ' + xhr.status;
    }
  };
  xhr.send('script=' + encodeURIComponent(name));
}

function load_config() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '<%=url("admin/services/portal/config_get")%>', true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        var ta = document.getElementById('config-text');
        var sec = document.getElementById('config-section');
        if (ta && sec) {
          ta.value = resp.content || '';
          sec.style.display = 'block';
        }
      } catch (e) {
        alert('Erreur chargement config: ' + e);
      }
    } else {
      alert('Erreur HTTP ' + xhr.status);
    }
  };
  xhr.send();
}

function save_config() {
  var ta = document.getElementById('config-text');
  if (!ta) return;
  
  var content = ta.value;
  if (!content.trim()) {
    alert('Config vide!');
    return;
  }
  
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '<%=url("admin/services/portal/config_set")%>', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        alert(resp.success ? 'Sauvegardee' : 'Erreur: ' + resp.output);
      } catch (e) {
        alert('Erreur parse: ' + e);
      }
    } else {
      alert('HTTP ' + xhr.status);
    }
  };
  xhr.send('content=' + encodeURIComponent(content));
}

window.addEventListener('load', function() {
  load_status();
  load_patches();
});

var current_patch_name = null;

function handle_dragover(e) {
  e.preventDefault();
  e.stopPropagation();
  e.currentTarget.style.background = '#e8f5e9';
}

function handle_dragleave(e) {
  e.preventDefault();
  e.stopPropagation();
  e.currentTarget.style.background = '#f9f9f9';
}

function handle_drop(e) {
  e.preventDefault();
  e.stopPropagation();
  e.currentTarget.style.background = '#f9f9f9';
  
  var files = e.dataTransfer.files;
  if (files.length > 0) {
    handle_file_select({ target: { files: files } });
  }
}

function upload_click() {
  document.getElementById('upload-input').click();
}

document.getElementById('upload-area').addEventListener('click', upload_click);

function handle_file_select(e) {
  var files = e.target.files;
  if (files.length === 0) return;
  
  var file = files[0];
  var filename = file.name;
  
  if (!filename.match(/patch/) || !filename.match(/\.sh$/)) {
    alert('Nom invalide: doit contenir "patch" et finir par .sh');
    return;
  }
  
  var ta = document.getElementById('upload-status-text');
  var sec = document.getElementById('upload-status');
  if (!ta || !sec) return;
  
  ta.value = 'Upload de ' + filename + ' en cours...';
  sec.style.display = 'block';
  
  var reader = new FileReader();
  reader.onload = function(event) {
    var content = event.target.result;
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/portal/patch_upload")%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    
    xhr.onload = function() {
      if (xhr.status === 200) {
        try {
          var resp = JSON.parse(xhr.responseText);
          ta.value = resp.success ? ('[OK] ' + resp.output) : ('[FAIL] ' + resp.output);
          if (resp.success) {
            setTimeout(function() { load_patches(); }, 500);
          }
        } catch (e) {
          ta.value = 'Erreur parse: ' + e;
        }
      } else {
        ta.value = 'HTTP ' + xhr.status;
      }
    };
    
    var data = 'filename=' + encodeURIComponent(filename) + '&file=' + encodeURIComponent(content);
    xhr.send(data);
  };
  
  reader.readAsText(file);
}


function load_patches() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '<%=url("admin/services/portal/patches_list")%>', true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        if (resp.success && resp.patches) {
          var tbody = document.getElementById('patches-tbody');
          var sec = document.getElementById('patches-list-section');
          if (tbody && sec) {
            tbody.innerHTML = '';
            if (resp.patches.length === 0) {
              tbody.innerHTML = '<tr><td colspan="2" style="padding:10px;color:#999">Aucun patch trouve</td></tr>';
            } else {
              for (var i = 0; i < resp.patches.length; i++) {
                var p = resp.patches[i];
                var row = '<tr style="border-bottom:1px solid #ddd"><td style="padding:8px">' + p.name + '</td>';
                row += '<td style="text-align:center"><button class="btn cbi-button cbi-button-apply" onclick="patch_run_action(\'' + p.name + '\')" style="padding:3px 8px;font-size:11px">RUN</button> ';
                row += '<button class="btn cbi-button" onclick="patch_view_code(\'' + p.name + '\')" style="padding:3px 8px;font-size:11px">VIEW</button> ';
                row += '<button class="btn cbi-button cbi-button-reset" onclick="patch_delete_confirm(\'' + p.name + '\')" style="padding:3px 8px;font-size:11px">DEL</button></td></tr>';
                tbody.innerHTML += row;
              }
            }
            sec.style.display = 'block';
          }
        }
      } catch (e) {
        alert('Erreur chargement patches: ' + e);
      }
    }
  };
  xhr.send();
}

function patch_run_action(name) {
  var ta = document.getElementById('patch-run-text');
  var sec = document.getElementById('patch-run-section');
  if (!ta || !sec) return;
  
  ta.value = 'Execution du patch ' + name + ' en cours...';
  sec.style.display = 'block';
  
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '<%=url("admin/services/portal/patch_run")%>', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        ta.value = '[' + resp.timestamp + ']\n' + (resp.success ? '[OK]' : '[FAIL]') + '\n' + (resp.output || '');
      } catch (e) {
        ta.value = 'Erreur: ' + e.toString();
      }
    } else {
      ta.value = 'HTTP ' + xhr.status;
    }
  };
  xhr.send('patch=' + encodeURIComponent(name));
}

function patch_view_code(name) {
  current_patch_name = name;
  var ta = document.getElementById('patch-view-text');
  var sec = document.getElementById('patch-view-section');
  if (!ta || !sec) return;
  
  ta.value = 'Chargement du code...';
  
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '<%=url("admin/services/portal/patch_view")%>?patch=' + encodeURIComponent(name), true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        ta.value = resp.success ? (resp.content || '') : 'Erreur: ' + resp.output;
        sec.style.display = 'block';
      } catch (e) {
        ta.value = 'Erreur parse: ' + e;
        sec.style.display = 'block';
      }
    } else {
      ta.value = 'HTTP ' + xhr.status;
      sec.style.display = 'block';
    }
  };
  xhr.send();
}

function patch_download_file() {
  if (!current_patch_name) {
    alert('Aucun patch selectionne');
    return;
  }
  window.location = '<%=url("admin/services/portal/patch_download")%>?patch=' + encodeURIComponent(current_patch_name);
}

function patch_view_logs() {
  if (!current_patch_name) {
    alert('Aucun patch selectionne');
    return;
  }
  
  var ta = document.getElementById('patch-logs-text');
  var sec = document.getElementById('patch-logs-section');
  if (!ta || !sec) return;
  
  ta.value = 'Chargement des logs...';
  
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '<%=url("admin/services/portal/patch_logs")%>?patch=' + encodeURIComponent(current_patch_name), true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        ta.value = resp.success ? (resp.logs || 'Pas de logs') : 'Erreur: ' + resp.output;
        sec.style.display = 'block';
      } catch (e) {
        ta.value = 'Erreur parse: ' + e;
        sec.style.display = 'block';
      }
    } else {
      ta.value = 'HTTP ' + xhr.status;
      sec.style.display = 'block';
    }
  };
  xhr.send();
}

function patch_close_view() {
  document.getElementById('patch-view-section').style.display = 'none';
  current_patch_name = null;
}

function patch_close_logs() {
  document.getElementById('patch-logs-section').style.display = 'none';
}

function patch_delete_confirm(name) {
  if (!confirm('Etes-vous sur de vouloir supprimer ' + name + ' ?\nLe fichier et son historique seront effaces mais pas les actions du patch sur votre systeme.')) {
    return;
  }
  patch_delete(name);
}

function patch_delete(name) {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '<%=url("admin/services/portal/patch_delete")%>', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        alert(resp.success ? 'Supprime' : 'Erreur: ' + resp.output);
        if (resp.success) {
          load_patches();
        }
      } catch (e) {
        alert('Erreur parse: ' + e);
      }
    } else {
      alert('HTTP ' + xhr.status);
    }
  };
  xhr.send('patch=' + encodeURIComponent(name));
}

// Logs export
function export_logs_local() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '<%=url("admin/services/portal/export_logs")%>', true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        if (resp.success) {
          document.getElementById('logs-export-text').value = resp.logs;
          document.getElementById('logs-export-section').style.display = 'block';
          document.getElementById('logs-paste-section').style.display = 'none';
        } else {
          alert('Erreur export logs');
        }
      } catch (e) {
        alert('Erreur parse: ' + e);
      }
    } else {
      alert('HTTP ' + xhr.status);
    }
  };
  xhr.send();
}

function export_logs_paste() {
  if (!confirm('ATTENTION: Ceci va partager TOUS les logs systeme sur Internet (paste.rs).\n\nLes donnees seront publiques et accessibles via un lien.\n\nEtes-vous sur de vouloir continuer ?')) {
    return;
  }
  
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '<%=url("admin/services/portal/paste_logs")%>', true);
  xhr.onload = function() {
    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        if (resp.success && resp.url) {
          document.getElementById('logs-paste-url').value = resp.url;
          document.getElementById('logs-paste-section').style.display = 'block';
          document.getElementById('logs-export-section').style.display = 'none';
        } else {
          alert('Erreur partage logs');
        }
      } catch (e) {
        alert('Erreur parse: ' + e);
      }
    } else {
      alert('HTTP ' + xhr.status);
    }
  };
  xhr.send();
}

function copy_logs_to_clipboard() {
  var textarea = document.getElementById('logs-export-text');
  textarea.select();
  document.execCommand('copy');
  alert('Logs copies !');
}

function copy_paste_url() {
  var input = document.getElementById('logs-paste-url');
  input.select();
  document.execCommand('copy');
  alert('Lien copie !');
}

function download_logs() {
  var logs = document.getElementById('logs-export-text').value;
  var blob = new Blob([logs], {type: 'text/plain'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'portal-logs-' + new Date().getTime() + '.txt';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
<%+footer%>