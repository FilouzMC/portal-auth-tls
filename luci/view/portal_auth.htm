<%+header%>

<h2 name="content"><%:Portal Auth - Gestion%></h2>

<fieldset class="cbi-section">
    <legend><%:Actions%></legend>
    
    <div class="cbi-section-node">
        <div class="cbi-value">
            <label class="cbi-value-title"><%:Authentification%></label>
            <div class="cbi-value-field">
                <input type="button" class="cbi-button cbi-button-apply" 
                       value="<%:Lancer l'authentification%>" 
                       onclick="executeScript('auth')" />
                <p class="cbi-value-description">
                    Exécute le script d'authentification au portail captif
                </p>
            </div>
        </div>

        <div class="cbi-value">
            <label class="cbi-value-title"><%:Déconnexion%></label>
            <div class="cbi-value-field">
                <input type="button" class="cbi-button cbi-button-reset" 
                       value="<%:Se déconnecter%>" 
                       onclick="executeScript('logout')" />
                <p class="cbi-value-description">
                    Déconnecte du portail captif
                </p>
            </div>
        </div>

        <div class="cbi-value">
            <label class="cbi-value-title"><%:Mise à jour%></label>
            <div class="cbi-value-field">
                <input type="button" class="cbi-button cbi-button-action" 
                       value="<%:Vérifier les mises à jour%>" 
                       onclick="executeScript('check_update')" />
                <p class="cbi-value-description">
                    Vérifie et installe les mises à jour disponibles
                </p>
            </div>
        </div>
    </div>
</fieldset>

<fieldset class="cbi-section">
    <legend><%:Sortie du script%></legend>
    <div class="cbi-section-node">
        <div id="output-container" style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
            <em>Aucune action exécutée</em>
        </div>
    </div>
</fieldset>

<script type="text/javascript">
    function executeScript(action) {
        var outputDiv = document.getElementById('output-container');
        outputDiv.innerHTML = '<em>Exécution en cours...</em>';
        
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '<%=url("admin/services/portal_auth")%>/' + action, true);
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        outputDiv.textContent = response.output || 'Commande exécutée avec succès';
                    } else {
                        outputDiv.textContent = 'Erreur: ' + (response.message || 'Erreur inconnue');
                    }
                } catch(e) {
                    outputDiv.textContent = 'Erreur de parsing: ' + e.message;
                }
            } else {
                outputDiv.textContent = 'Erreur HTTP: ' + xhr.status;
            }
        };
        
        xhr.onerror = function() {
            outputDiv.textContent = 'Erreur de connexion';
        };
        
        xhr.send();
    }
</script>

<%+footer%>
